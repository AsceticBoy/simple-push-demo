<!doctype html>
<!--
Copyright (c) 2014 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE
The complete set of authors may be found at http://polymer.github.io/AUTHORS
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS
-->
<html>
<head>
  <title>PolyAir</title>


  <!-- Trigger Ganesh (GPU raster) on Chrome for Android -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <!-- Enable "installability" -->
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-touch-fullscreen" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style"
        content="black-translucent" >
  <meta name="format-detection" content="telephone=no">
  <link rel="shortcut icon" href="favicon.ico">
  <link rel="icon" sizes="96x96" href="icons/icon-96.png">
  <meta name="application-name" content="PolyAir">

  <!--
  Chrome 35 has old :host behavior before :host-context addition.
  Since Chrome 35 does not have HTMLImports, we can use this as a decent signal
  to force the ShadowDOM Polyfill.
  -->
  <script>
    if (!('import' in document.createElement('link'))) {
      var Platform = {flags: {shadow: true}};
    }
  </script>

  <script src="lib/localforage.js"></script>

  <script src="components/webcomponentsjs/webcomponents.min.js"></script>
  <link rel="import" href="components/font-roboto/roboto.html">
  <link rel="import" href="components/core-icons/core-icons.html">
  <link rel="import" href="components/core-icons/av-icons.html">
  <link rel="import" href="components/core-icons/social-icons.html">
  <link rel="import" href="components/core-icons/maps-icons.html">
  <link rel="import" href="components/core-drawer-panel/core-drawer-panel.html">
  <link rel="import" href="components/core-animated-pages/core-animated-pages.html">
  <link rel="import" href="components/core-animated-pages/transitions/slide-from-right.html">
  <link rel="import" href="components/core-scaffold/core-scaffold.html">
  <link rel="import" href="components/paper-button/paper-button.html">
  <link rel="import" href="components/paper-icon-button/paper-icon-button.html">
  <link rel="import" href="components/paper-checkbox/paper-checkbox.html">
  <link rel="import" href="components/paper-fab/paper-fab.html">
  <link rel="import" href="components/paper-input/paper-input.html">
  <link rel="import" href="components/paper-item/paper-item.html">
  <link rel="import" href="components/paper-toast/paper-toast.html">
  <link rel="import" href="components/more-routing/more-route.html">
  <link rel="import" href="components/more-routing/more-route-selector.html">
  <link rel="import" href="components/more-routing/more-routing.html">
  <link rel="import" href="components/more-routing/more-route-switch.html">
  <link rel="import" href="flight-panel.html">

  <link rel="stylesheet" href="theme.css" shim-shadowdom>

  <script>
    var log = console.log.bind(console);
    var err = console.error.bind(console);
    var _swRef = null;
    var swReady = function() {
      if (_swRef) {
        return Promise.resolve(_swRef);
      }
      // Paper over 37<-->40 changes
      return navigator.serviceWorker.ready ||
             navigator.serviceWorker.whenReady();
    };

    window.addEventListener('polymer-ready', function(e) {
      "use strict";

      var showNoSWMessage = function() {
        document.querySelector('#no-sw').show();
      };

      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register("flight-info-sw.js").then(
          function(reg) {
            // for old Chrome impl
            if (reg instanceof ServiceWorker) { _swRef = reg; }
          },
          showNoSWMessage
        );
      } else {
        setTimeout(showNoSWMessage, 1000);
      }
    });

    var goTo = function(route) {
      MoreRouting.navigateTo(route);
    };

    // FIXME(slightlyoff): move out to better location
    var flightData = {
      'company': 'Polymer Airlines',
      'companyShort': 'PA',
      'flightNumber': '930',
      'status': 'On time',
      'departCode': 'SFO',
      'departCity': 'San Francisco',
      'departDate': 'Monday, 27 October',
      'departTime': '18:05',
      'departTerminal': 'INTL',
      'departGate': 'G97',
      'arrivalCode': 'LHR',
      'arrivalCity': 'London',
      'arrivalDate': 'Tuesday, 28 October',
      'arrivalTime': '11:30',
      'arrivalTerminal': '2',
      'arrivalGate': '-',
    };

    window.addEventListener('polymer-ready', function(e) {
      localforage.getItem('track').then(function(flight) {
        document.querySelector("#content").flight = flight;
      });
    });

    var updateTrackedFlight = function() {
      localforage.getItem('track').then(function(flight) {
        var elt = document.createElement('flight-panel');
        elt.model = flight;
        document.getElementById('track-content').appendChild(elt);
      });
    }

    /*
    var showTrackMenu = function() {
      var trackMenu = document.getElementById('track-menu');
      trackMenu.hidden = trackMenu.previousElementSibling.hidden = false;
    }
    */

    var sendRegistration = function(registration) {
      console.log('sending ' + registration + ' to ' + location.hostname);

      var formData = new FormData();
      formData.append('registration', registration);

      var xhr = new XMLHttpRequest();
      xhr.onload = function() {
        console.log('registration with server status: ' + JSON.parse(xhr.response).success);
      };
      xhr.onerror = xhr.onabort = function() {
        console.log('registration with server failed');
      };
      xhr.open('POST', '/register_track');
      xhr.send(formData);
    }

    var startTracking = function() {
      if (!navigator.push) {
        document.querySelector('#push-error').show();
        return;
      }

      swReady().then(function() {
        navigator.push.register('129757602160').then(
          function(pushRegistration) {
            document.querySelector('#push-success').show();

            console.log(pushRegistration.pushRegistrationId);
            sendRegistration(pushRegistration.pushRegistrationId);

            localforage.setItem('track', flightData);
            showTrackMenu();
          },
          function(e) {
            document.querySelector('#push-error').show();
            console.log('Push registration failed: ' + e);
          }
        );
      }, err);
    }
  </script>

</head>
<body unresolved fullbleed>

  <template id='content' is="auto-binding">

    <more-routing driver="hash"></more-routing>
    <more-route-selector selectedIndex="{{orderedIndex}}"
      routes="['/booking', '/checkin', '/confirmation', '/travel-info', '/committers', '/track','/settings', '/help', '/']"></more-route-selector>

    <core-scaffold id="scaffold">

      <core-header-panel navigation flex>
        <core-menu>
<!--           <paper-item
            onclick="goTo('/');"
            icon="" label="Home"></paper-item>
 -->
          <paper-item onclick="goTo('/booking');"
            icon="add" label="Book a trip"></paper-item>
          <hr>
          <paper-item onclick="goTo('/checkin');"
            icon="work" label="Check-in"></paper-item>
          <paper-item onclick="goTo('/travel-info');"
            icon="schedule" label="Travel information"></paper-item>
          <paper-item onclick="goTo('/committers');"
            icon="account-circle" label="Committer Program"></paper-item>
          <hr>
          <paper-item onclick="goTo('/track');"
            id="track-menu" icon="star" label="Tracked Flights"></paper-item>
          <hr>
          <paper-item onclick="goTo('/settings');"
            icon="settings" label="Settings"></paper-item>
          <hr>
          <paper-item onclick="goTo('/help');"
            icon="help" label="Help &amp; Feedback"></paper-item>
        </core-menu>
      </core-header-panel>

      <core-toolbar tool flex id="main-heading">
        <paper-icon-button icon="maps:flight"></paper-icon-button>
        <span flex>PolyAir</span>
        <paper-icon-button id="searchbutton" icon="search"></paper-icon-button>
      </core-toolbar>

      <div layout horizontal left-center>
        <core-animated-pages selected="{{orderedIndex}}" transitions="slide-from-right">
          <section>
            <!-- /booking -->
            <div>Booking</div>
          </section>
          <section>
            <!-- /checkin -->
            <paper-input class="narrow" required label="Booking reference"></paper-input>
            <paper-input class="narrow" required label="Last name"></paper-input>
            <paper-button onclick="goTo('/confirmation');" raised class="colored">Submit</paper-button>
          </section>
          <section id="confirmation">
            <!-- /confirmation -->
            <flight-panel company="{{flight.company}}"
                          flightNumber="{{flight.flightNumber}}"
                          status="{{flight.status}}"
                          departCode="{{flight.departCode}}"
                          departCity="{{flight.departCity}}"
                          departDate="{{flight.departDate}}"
                          departTime="{{flight.departTime}}"
                          departTerminal="{{flight.departTerminal}}"
                          departGate="{{flight.departGate}}"
                          arrivalCode="{{flight.arrivalCode}}"
                          arrivalCity="{{flight.arrivalCity}}"
                          arrivalDate="{{flight.arrivalDate}}"
                          arrivalTime="{{flight.arrivalTime}}"
                          arrivalTerminal="{{flight.arrivalTerminal}}"
                          arrivalGate="{{flight.arrivalGate}}">
            </flight-panel>
            <paper-item icon="social:person" label="Mounir Lamouri">
              <paper-button class="colored">
                <core-icon icon="check"></core-icon>
              </paper-button>
            </paper-item>
            <paper-item icon="maps:my-location" label="42 A">
              <paper-button class="colored">
                <core-icon icon="check"></core-icon>
              </paper-button>
            </paper-item>
            <div class='notification-checkbox' horizontal layout>
              <paper-checkbox></paper-checkbox>
              <div>Notify me about flight status updates</div>
            </div>
            <paper-button class="colored checkin" onclick="startTracking();">
              <core-icon icon="check"></core-icon>
              ok
            </paper-button>
            <paper-button class="checkin"
              onclick="goTo('/checkin');">
              <core-icon icon="clear"></core-icon>
              cancel
            </paper-button>
          </section>
          <section>
            <!-- /travel-info -->
            <div>TODO: /travel-info</div>
          </section>
          <section>
            <!-- /committers -->
            <div>TODO: /committers</div>
          </section>
          <section>
            <!-- /help -->
            <div>TODO: /help</div>
          </section>
          <section>
            <!-- / -->
            <div>Welcome to PolyAir!<br>
              Getting you from here to there, with flair.
            </div>
            <paper-fab icon='add' class='red'></paper-fab>
          </section>
        </core-animated-pages>
      </div>
    </core-scaffold>

    <paper-toast id="no-sw" text="Service Worker is not available. This demo isn't going to work."></paper-toast>
    <paper-toast id="push-success" text="Push registration succeeded. We will keep you posted."></paper-toast>
    <paper-toast id="push-error" text="Push registration failed. Sorry :("></paper-toast>
  </template>

</body>
</html>
